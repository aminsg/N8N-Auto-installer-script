#!/bin/bash

# ==============================================================================
# ุงุณฺฉุฑูพุช ูุตุจ ุฎูุฏฺฉุงุฑ n8n ุจุง Dockerุ Nginx ู Let's Encrypt SSL
# ุงุณุชูุงุฏู: ./install.sh yourdomain.com
# ==============================================================================

# ุจุฑุฑุณ ุงูฺฉู ุขุง ุงุณฺฉุฑูพุช ุจุง ุฏุณุชุฑุณ root ุงุฌุฑุง ุดุฏู ุงุณุช ุง ุฎุฑ
if [ "$EUID" -ne 0 ]; then
  echo "โ ุงู ุงุณฺฉุฑูพุช ุจุงุฏ ุจุง sudo ุง ุจู ุนููุงู ฺฉุงุฑุจุฑ root ุงุฌุฑุง ุดูุฏ."
  echo "ุงุณุชูุงุฏู: sudo ./install.sh yourdomain.com"
  exit 1
fi

# ุจุฑุฑุณ ุงูฺฉู ุขุง ูพุงุฑุงูุชุฑ ุฏุงููู ูุงุฑุฏ ุดุฏู ุงุณุช ุง ุฎุฑ
if [ -z "$1" ]; then
  echo "โ ูุทูุงู ุฏุงููู ุฎูุฏ ุฑุง ุจู ุนููุงู ูพุงุฑุงูุชุฑ ูุงุฑุฏ ฺฉูุฏ."
  echo "ุงุณุชูุงุฏู: sudo ./install.sh yourdomain.com"
  exit 1
fi

DOMAIN=$1
N8N_PORT=5678
N8N_CONTAINER_NAME="n8n"
N8N_VOLUME_NAME="n8n_data"

echo "โ ุดุฑูุน ูุตุจ n8n ุจุฑุง ุฏุงููู: ${DOMAIN}"
echo "--------------------------------------------------------"

# ------------------------------------------------------------------------------
# ฑ. ูุตุจ Docker ู ูุงุจุณุชฺฏโูุง
# ------------------------------------------------------------------------------
echo "โ๏ธ ฑ. ูุตุจ Docker ู ุจูโุฑูุฒุฑุณุงู ุณุณุชู..."
apt update -y
apt upgrade -y
apt install docker.io nginx python3-certbot-nginx -y

# ุงุทููุงู ุงุฒ ุงุฌุฑุง ุณุฑูุณโูุง ููุฑุฏ ูุงุฒ
systemctl start docker
systemctl enable docker
systemctl start nginx
systemctl enable nginx

echo "โ Docker ู Nginx ูุตุจ ุดุฏูุฏ."

# ------------------------------------------------------------------------------
# ฒ. ุฑุงูโุงูุฏุงุฒ ฺฉุงูุชูุฑ n8n
# ------------------------------------------------------------------------------
echo "โ๏ธ ฒ. ุฑุงูโุงูุฏุงุฒ ฺฉุงูุชูุฑ n8n..."

# ุญุฐู ฺฉุงูุชูุฑ ู ูููู ูุฏู ุฏุฑ ุตูุฑุช ูุฌูุฏ
docker stop ${N8N_CONTAINER_NAME} > /dev/null 2>&1
docker rm ${N8N_CONTAINER_NAME} > /dev/null 2>&1
docker volume create ${N8N_VOLUME_NAME} > /dev/null 2>&1

# ุงุฌุฑุง ฺฉุงูุชูุฑ n8n
docker run -d \
  --name ${N8N_CONTAINER_NAME} \
  -p ${N8N_PORT}:${N8N_PORT} \
  -v ${N8N_VOLUME_NAME}:/home/node/.n8n \
  -e N8N_HOST=${DOMAIN} \
  -e N8N_PROTOCOL=https \
  -e WEBHOOK_URL=https://${DOMAIN}/ \
  n8nio/n8n

if [ $? -ne 0 ]; then
    echo "โ ุฎุทุง ุฏุฑ ุงุฌุฑุง ฺฉุงูุชูุฑ n8n ุฑุฎ ุฏุงุฏ. ูุทูุงู ูุงฺฏโูุง Docker ุฑุง ุจุฑุฑุณ ฺฉูุฏ."
    exit 1
fi

echo "โ n8n ุจุง ููููุช ุฏุฑ ูพูุฑุช ${N8N_PORT} ุฑุงูโุงูุฏุงุฒ ุดุฏ."

# ------------------------------------------------------------------------------
# ณ. ุชูุธู Reverse Proxy ุจุง Nginx ู ุฑูุน ูุดฺฉู ูุจโุณูฺฉุช
# ------------------------------------------------------------------------------
echo "โ๏ธ ณ. ุชูุธู Nginx Reverse Proxy..."

NGINX_CONF="/etc/nginx/sites-available/n8n"
NGINX_SYMLINK="/etc/nginx/sites-enabled/n8n"

# ุงุฌุงุฏ ูุงู ฺฉุงููฺฏ Nginx
cat <<EOL > ${NGINX_CONF}
server {
    listen 80;
    server_name ${DOMAIN} www.${DOMAIN};

    location / {
        # ุงูุชูุงู ุฏุฑุฎูุงุณุชโูุง ุจู n8n
        proxy_pass http://127.0.0.1:${N8N_PORT};
        proxy_http_version 1.1;

        # ุฑูุน ูุดฺฉู ูุจโุณูฺฉุช
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";

        # ุชูุธูุงุช ูพุฑูฺฉุณ
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOL

# ูุนุงูโุณุงุฒ ุณุงุช
ln -sf ${NGINX_CONF} ${NGINX_SYMLINK}

# ุจุฑุฑุณ ุณูุชฺฉุณ ู ุจุงุฑฺฏุฐุงุฑ ูุฌุฏุฏ Nginx
if nginx -t; then
    systemctl reload nginx
    echo "โ ุชูุธูุงุช Nginx ุจุง ููููุช ุงุนูุงู ุดุฏ."
else
    echo "โ ุฎุทุง ุณูุชฺฉุณ ุฏุฑ ุชูุธูุงุช Nginx. ูุตุจ ูุชููู ุดุฏ."
    exit 1
fi

# ------------------------------------------------------------------------------
# ด. ุฏุฑุงูุช ู ุงุนูุงู ฺฏูุงู SSL ุจุง Certbot
# ------------------------------------------------------------------------------
echo "โ๏ธ ด. ุฏุฑุงูุช ฺฏูุงู SSL ุงุฒ Let's Encrypt..."

# Certbot ุฑุง ุงุฌุฑุง ูโฺฉูู. --nginx ุขู ุฑุง ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ ุฏุฑ Nginx ุชูุธู ูโฺฉูุฏ.
certbot --nginx -d ${DOMAIN} --non-interactive --agree-tos --email your_email@example.com
if [ $? -ne 0 ]; then
    echo "โ๏ธ ุฎุทุง ุฏุฑ ุฏุฑุงูุช SSL ุฑุฎ ุฏุงุฏ. ูุทูุงู ูุทูุฆู ุดูุฏ ฺฉู ุฏุงููู ${DOMAIN} ุจู IP ุณุฑูุฑ ุดูุง ุงุดุงุฑู ูโฺฉูุฏ."
    echo "ูุตุจ ุจู ูพุงุงู ุฑุณุฏุ ุงูุง ุดูุง ุจุงุฏ SSL ุฑุง ุจู ุตูุฑุช ุฏุณุช ุฑูุน ฺฉูุฏ."
else
    echo "โ ฺฏูุงู SSL ุจุง ููููุช ุฏุฑุงูุช ู ูุนุงู ุดุฏ. Nginx ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ reload ุดุฏ."
fi

# ------------------------------------------------------------------------------
# ต. ูพุงุงู ู ูพุงู ููููุช
# ------------------------------------------------------------------------------
echo "--------------------------------------------------------"
echo "๐ ูุตุจ n8n ุจุง ููููุช ุจู ูพุงุงู ุฑุณุฏ!"
echo "ุฏุณุชุฑุณ ุจู n8n ุงุฒ ุทุฑู HTTPS:"
echo "โก๏ธ https://${DOMAIN}"
echo ""
echo "ูุทูุงู ุจุฑุง ุงููู ุจุงุฑ ูุงุฑุฏ ุดุฏู ู ฺฉ ฺฉุงุฑุจุฑ ุงุฌุงุฏ ฺฉูุฏ."
echo "ุชูุฏุฏ ฺฏูุงู SSL ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุชูุณุท Certbot (ุงุฒ ุทุฑู Cronjob) ุงูุฌุงู ุฎูุงูุฏ ุดุฏ."
echo "--------------------------------------------------------"